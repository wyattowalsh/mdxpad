# Implementation Plan: Keyboard Shortcuts & Command Palette

**Branch**: `005-command-palette` | **Date**: 2026-01-10 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/005-command-palette/spec.md`

## Summary

Implement a VS Code-style command palette (`Cmd+Shift+P`) and keyboard shortcuts system for mdxpad. The system provides a central command registry (Zustand store), fuzzy-searchable command palette UI (React + ARIA), and platform-aware keyboard shortcuts integrated with Electron native menus and CodeMirror editor commands.

**Key Technical Decisions from Research:**
- Command Registry: Zustand 5.x + immer middleware following existing `preview-store.ts` patterns
- Fuzzy Search: Custom VS Code-style algorithm (~85 lines, zero external deps)
- Menu Integration: Extend `menu.ts` with `webContents.send()` for menu-to-renderer communication
- Editor Commands: Leverage existing `executeCommand()` pattern from `commands.ts`
- Accessibility: ARIA combobox + listbox, React-based focus trap (~30 lines)

## Technical Context

**Language/Version**: TypeScript 5.9.x with `strict: true` (per Constitution Article II)
**Primary Dependencies**: Electron 39.x, React 19.x, Zustand 5.x + Immer 11.x, CodeMirror 6.x, zod 4.x
**Storage**: localStorage for recent commands and UI state persistence
**Testing**: Vitest 4.x (unit), Playwright 1.57.x (E2E), colocated test files
**Target Platform**: macOS only through v2.0 (per Constitution Preamble)
**Project Type**: Electron application with main/renderer/preload process separation
**Performance Goals**: <100ms shortcut response time, <1ms fuzzy search, 150ms palette animation
**Constraints**: <5MB renderer bundle, no external shortcut libraries, contextIsolation: true
**Scale/Scope**: ~20 built-in commands, extensible registry for future features

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Article | Requirement | Status | Notes |
|---------|-------------|--------|-------|
| II | Technology Stack versions | PASS | Using Zustand 5.x, React 19.x, TypeScript 5.9.x strict |
| III.2 | contextIsolation: true | PASS | Using existing preload/IPC pattern |
| III.3 | IPC Channel Pattern | PASS | Using `mdxpad:menu:*` channels via existing menu.ts |
| III.4 | CodeMirror owns editor state | PASS | Commands dispatch via EditorView.dispatch |
| V | Renderer bundle < 5MB | PASS | No external libraries added, ~85 lines fuzzy search |
| V | Keystroke latency < 16ms | TBD | Will validate in implementation |
| VI.1 | strict: true, JSDoc | PASS | All types exported with documentation |
| VI.2 | Functions < 50 lines, Files < 400 lines | PASS | Architecture supports limits |
| VI.4 | Unit coverage > 80%, Integration tests for IPC | TBD | Planned in tasks |
| VII.1 | Native menu bar via Electron Menu API | PASS | Extending existing menu.ts |
| VII.2 | Keyboard navigation, focus indicators | PASS | ARIA combobox pattern, focus trap |
| VIII.2 | Task-based commits | PASS | Each task gets own commit |

**Violations Requiring Justification**: None

## Project Structure

### Documentation (this feature)

```text
specs/005-command-palette/
├── spec.md              # Feature specification (input)
├── plan.md              # This file (implementation plan)
├── research.md          # Phase 0 research findings
├── data-model.md        # Entity definitions and relationships
├── quickstart.md        # Developer onboarding guide
├── contracts/           # Zod validation schemas
│   └── command-schemas.ts
└── tasks.md             # Phase 2 output (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
src/
├── main/
│   ├── menu.ts                    # MODIFY: Add command palette accelerator, menu events
│   └── ipc/
│       └── menu-handlers.ts       # NEW: Menu event IPC handlers (if needed)
├── preload/
│   └── api.ts                     # MODIFY: Add menu event listeners
├── renderer/
│   ├── components/
│   │   └── CommandPalette/
│   │       ├── CommandPalette.tsx     # NEW: Main palette component
│   │       ├── CommandPalette.test.tsx # NEW: Component tests
│   │       ├── CommandList.tsx        # NEW: Command list with virtualization
│   │       ├── CommandItem.tsx        # NEW: Individual command row
│   │       ├── SearchInput.tsx        # NEW: Fuzzy search input
│   │       └── index.ts               # NEW: Barrel export
│   ├── hooks/
│   │   ├── useCommandPalette.ts       # NEW: Palette state hook
│   │   ├── useFocusTrap.ts            # NEW: Focus trap hook
│   │   └── useKeyboardShortcuts.ts    # NEW: Global shortcut listener
│   ├── lib/
│   │   ├── fuzzy-search.ts            # NEW: VS Code-style fuzzy search
│   │   └── fuzzy-search.test.ts       # NEW: Fuzzy search tests
│   └── stores/
│       ├── command-registry-store.ts      # NEW: Command registry singleton
│       ├── command-registry-store.test.ts # NEW: Store tests
│       ├── ui-layout-store.ts             # NEW: UI panel visibility state
│       └── ui-layout-store.test.ts        # NEW: Store tests
└── shared/
    └── types/
        └── commands.ts                # NEW: Command type definitions

tests/
├── integration/
│   └── commands.test.ts           # NEW: IPC integration tests
└── e2e/
    └── command-palette.spec.ts    # NEW: E2E palette tests
```

**Structure Decision**: Follows existing Electron + React + Zustand architecture. New stores follow `preview-store.ts` pattern. Components follow existing component directory structure. Types in shared for cross-process usage.

## Complexity Tracking

> **No violations to justify.** All implementation choices align with Constitution requirements.

## Key Integration Points

### Existing Code to Leverage

| File | Pattern | Usage |
|------|---------|-------|
| `src/main/menu.ts` | Menu.buildFromTemplate, accelerators | Add command palette menu item |
| `src/preload/api.ts` | contextBridge.exposeInMainWorld | Add menu event listeners |
| `src/renderer/stores/preview-store.ts` | Zustand + immer, typed selectors | Pattern for new stores |
| `src/renderer/hooks/useCodeMirror/commands.ts` | executeCommand, view.dispatch | Pattern for editor commands |
| `src/shared/lib/ipc.ts` | IPC_CHANNELS, channel naming | Add menu channels |

### IPC Channels to Add

| Channel | Direction | Purpose |
|---------|-----------|---------|
| `mdxpad:menu:command-palette` | main→renderer | Open command palette |
| `mdxpad:menu:toggle-preview` | main→renderer | Toggle preview (via menu) |

### Commands to Wire

| Command ID | Shortcut | Target |
|------------|----------|--------|
| `file.save` | Cmd+S | IPC: `mdxpad:file:save` |
| `file.open` | Cmd+O | IPC: `mdxpad:file:open` |
| `edit.bold` | Cmd+B | CodeMirror: executeCommand |
| `view.togglePreview` | Cmd+\ | UILayoutStore.togglePreview |

---

## Next Steps

Run `/speckit.tasks` to generate `tasks.md` with implementation tasks derived from this plan.
