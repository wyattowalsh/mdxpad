# Smart Filtering for File Tree - Execution Manifest
# Generated: 2026-01-17
# Feature: 014-smart-filtering
# Orchestration: enabled

version: "1.0"
feature: "014-smart-filtering"
generated: "2026-01-17"

# =============================================================================
# EXECUTION CONFIG
# =============================================================================

config:
  model: opus-4.5
  max_parallel_subagents: 10
  queue_overflow: true
  default_task_timeout: 10m
  gate_timeout: 2m
  subagent_timeout: 15m
  circuit_breaker:
    max_failures_per_batch: 5
    action: pause_and_report
  retry_policy:
    max_attempts: 3
    backoff: exponential
  async_background:
    enabled: true
    wake_on_complete: true

# =============================================================================
# METRICS
# =============================================================================

metrics:
  total_tasks: 24
  total_phases: 7
  total_batches: 15
  critical_path_length: 8
  parallelism_factor: 3.0
  max_concurrent: 10
  theoretical_speedup: 3.0
  practical_speedup: 2.5

# =============================================================================
# PHASES
# =============================================================================

phases:
  - id: phase-1
    name: "Setup"
    purpose: "Install fzf dependency"
    blocking: true
    max_parallelism: 1
    batches:
      - id: batch-1.1
        name: "Dependencies"
        parallel: false
        tasks:
          - id: T001
            title: "Install fzf package"
            command: "npm install fzf"
            user_stories: []
            depends_on: []
        gate:
          name: "Dependency Validation"
          command: 'test -f package.json && grep -q ''"fzf"'' package.json'
          on_fail: "Verify npm install completed; check package.json for fzf entry"

  - id: phase-2
    name: "Foundational"
    purpose: "Core types, utilities, and store extension"
    blocking: true
    max_parallelism: 4
    batches:
      - id: batch-2.1
        name: "Types & Utilities"
        parallel: true
        context:
          - data-model.md
          - contracts/filter-schemas.ts
        tasks:
          - id: T002
            title: "Create filter types"
            file: "src/renderer/lib/fuzzy-match/types.ts"
            description: "FilterQuery, MatchResult, MatchPositions, FilterVisibility per data-model.md"
            user_stories: []
            depends_on: [T001]
          - id: T003
            title: "Create fuzzy matcher wrapper"
            file: "src/renderer/lib/fuzzy-match/matcher.ts"
            description: "Wrapper using fzf library per research.md"
            user_stories: []
            depends_on: [T001]
          - id: T004
            title: "Create tree filtering utilities"
            file: "src/renderer/lib/file-tree/filter-utils.ts"
            description: "computeNodeVisibility, shouldAutoExpand functions"
            user_stories: []
            depends_on: [T001]
          - id: T005
            title: "Create persistence utilities"
            file: "src/renderer/lib/fuzzy-match/persistence.ts"
            description: "getFilterStorageKey, loadFilterQuery, saveFilterQuery with FNV-1a hash"
            user_stories: []
            depends_on: [T001]
        gate:
          name: "Types & Utilities Validation"
          command: "npx tsc --noEmit src/renderer/lib/fuzzy-match/types.ts src/renderer/lib/fuzzy-match/matcher.ts src/renderer/lib/file-tree/filter-utils.ts src/renderer/lib/fuzzy-match/persistence.ts"
          on_fail: "Check data-model.md for type definitions; verify fzf import works"

      - id: batch-2.2
        name: "Store Extension"
        parallel: false
        context:
          - data-model.md#store
          - existing file-explorer-store.ts
        tasks:
          - id: T006
            title: "Extend file-explorer-store with filter state"
            file: "src/renderer/stores/file-explorer-store.ts"
            description: "FileTreeFilterState, FileTreeFilterActions per data-model.md Section 7"
            user_stories: []
            depends_on: [T002, T003, T004, T005]
        gate:
          name: "Store Validation"
          command: "npx tsc --noEmit src/renderer/stores/file-explorer-store.ts"
          on_fail: "Verify Immer MapSet plugin enabled; check action signatures match data-model.md"
    checkpoint: "Foundation ready — user story implementation can begin"

  - id: phase-3
    name: "US1+2 Core Filtering & Fuzzy Matching"
    purpose: "Implement filter input that filters file tree using fzf-style fuzzy matching"
    blocking: true
    priority: P1
    mvp: true
    max_parallelism: 3
    user_stories: [US1, US2]
    batches:
      - id: batch-3.1
        name: "Filter Component"
        parallel: true
        context:
          - plan.md#components
          - data-model.md
          - quickstart.md#usage
        tasks:
          - id: T007
            title: "Create FileTreeFilter component"
            file: "src/renderer/components/file-explorer/FileTreeFilter.tsx"
            description: |
              - Text input with placeholder "Filter files..."
              - 50ms debounced onChange per FR-010
              - Clear button (X icon) when query non-empty
              - Escape key handling (clear first, then blur)
              - Connect to store actions (setFilterQuery, clearFilter)
            user_stories: [US1]
            depends_on: [T006]
          - id: T008
            title: "Create debounce hook"
            file: "src/renderer/hooks/useFilterDebounce.ts"
            description: "50ms debounce for filter input per FR-010"
            user_stories: [US1]
            depends_on: [T006]
        gate:
          name: "Component Validation"
          command: "npx tsc --noEmit src/renderer/components/file-explorer/FileTreeFilter.tsx src/renderer/hooks/useFilterDebounce.ts"
          on_fail: "Check store imports; verify React 19 compatibility"

      - id: batch-3.2
        name: "File Tree Integration"
        parallel: false
        context:
          - existing FileExplorer.tsx
          - store selectors
        tasks:
          - id: T009
            title: "Integrate filter into file tree rendering"
            file: "src/renderer/components/file-explorer/FileExplorer.tsx"
            description: |
              - Add FileTreeFilter component above tree
              - Filter visible nodes based on matchResults
              - Auto-expand folders with matching descendants
              - Show empty state when no matches (FR-011)
              - Maintain tree structure with ancestor nodes visible (FR-004)
            user_stories: [US1]
            depends_on: [T007, T008]
        gate:
          name: "Integration Validation"
          command: "npx tsc --noEmit src/renderer/components/file-explorer/FileExplorer.tsx"
          on_fail: "Verify store selectors work; check visibility computation logic"
    checkpoint: "User Story 1+2 complete — filtering with fuzzy matching works"
    independent_test: "Type a query → only matching files shown, fuzzy patterns work"

  - id: phase-4
    name: "US3 Visual Match Highlighting"
    purpose: "Highlight matched character positions in file/folder names"
    blocking: false
    priority: P2
    max_parallelism: 2
    user_stories: [US3]
    parallel_with: [phase-5, phase-6]
    batches:
      - id: batch-4.1
        name: "Highlight Component"
        parallel: false
        context:
          - contracts/filter-schemas.ts#positionsToSegments
          - quickstart.md#highlighting
        tasks:
          - id: T010
            title: "Create FilterHighlight component"
            file: "src/renderer/components/file-explorer/FilterHighlight.tsx"
            description: |
              - Accept text and positions (Set<number>) as props
              - Split text into matched/unmatched segments using positionsToSegments
              - Render matched chars with CSS class filter-match
              - Style: font-weight: 600, text-decoration: underline (Constitution VII.2)
            user_stories: [US3]
            depends_on: [T009]

      - id: batch-4.2
        name: "Apply Highlighting"
        parallel: false
        context:
          - FileExplorer.tsx
          - existing file/folder name rendering
        tasks:
          - id: T011
            title: "Integrate FilterHighlight into tree node rendering"
            file: "src/renderer/components/file-explorer/FileExplorer.tsx"
            description: |
              - Replace plain text name with FilterHighlight when filter active
              - Pass positions from matchResult to component
              - Apply to both files and folders
            user_stories: [US3]
            depends_on: [T010]
        gate:
          name: "Highlighting Validation"
          command: "npx tsc --noEmit src/renderer/components/file-explorer/FilterHighlight.tsx src/renderer/components/file-explorer/FileExplorer.tsx"
          on_fail: "Verify positionsToSegments import from contracts; check CSS exists"
    checkpoint: "User Story 3 complete — matched characters highlighted"
    independent_test: "Type query → matched characters visually distinguished"

  - id: phase-5
    name: "US4 Keyboard Shortcut Access"
    purpose: "Mod+P focuses filter input from anywhere in app"
    blocking: false
    priority: P2
    max_parallelism: 2
    user_stories: [US4]
    parallel_with: [phase-4, phase-6]
    batches:
      - id: batch-5.1
        name: "Command Registration"
        parallel: true
        context:
          - contracts/filter-commands.ts
          - existing command-registry-store.ts
        tasks:
          - id: T012
            title: "Register filter commands in command registry"
            description: |
              - Copy command definitions from contracts/filter-commands.ts
              - Register focusFilterCommand (Mod+P) and clearFilterCommand
              - Call registerFilterCommands on app init
            user_stories: [US4]
            depends_on: [T009]
          - id: T013
            title: "Add filter.focus to command palette"
            description: "Add to command palette for discoverability (SC-004)"
            user_stories: [US4]
            depends_on: [T009]
        gate:
          name: "Command Validation"
          command: "npx tsc --noEmit && node -e \"console.log('Commands registered')\""
          on_fail: "Verify command registry import; check no shortcut conflicts"

      - id: batch-5.2
        name: "Focus Handler"
        parallel: false
        context:
          - FileTreeFilter.tsx
          - contracts/filter-commands.ts#onFilterFocus
        tasks:
          - id: T014
            title: "Add focus event listener in FileTreeFilter"
            file: "src/renderer/components/file-explorer/FileTreeFilter.tsx"
            description: |
              - Use onFilterFocus helper from contracts
              - Focus input ref on event
              - Handle Escape behavior per acceptance scenarios
            user_stories: [US4]
            depends_on: [T012, T013]
        gate:
          name: "Focus Validation"
          command: "npx tsc --noEmit src/renderer/components/file-explorer/FileTreeFilter.tsx"
          on_fail: "Verify custom event dispatch works; check inputRef not null"
    checkpoint: "User Story 4 complete — Mod+P focuses filter"
    independent_test: "Press Mod+P anywhere → filter input receives focus"

  - id: phase-6
    name: "US5 Filter Persistence"
    purpose: "Filter query persists across app restarts per project"
    blocking: false
    priority: P3
    max_parallelism: 2
    user_stories: [US5]
    parallel_with: [phase-4, phase-5]
    batches:
      - id: batch-6.1
        name: "Persistence Integration"
        parallel: true
        context:
          - persistence.ts
          - file-explorer-store.ts
          - data-model.md#persistence
        tasks:
          - id: T015
            title: "Implement store persistence actions"
            file: "src/renderer/stores/file-explorer-store.ts"
            description: |
              - loadPersistedFilter: call on project open
              - persistFilter: call after filter results applied
              - Use persistence utilities from lib/fuzzy-match/persistence.ts
            user_stories: [US5]
            depends_on: [T009, T005]
          - id: T016
            title: "Add project path tracking"
            description: |
              - Call setProjectPath when project/workspace changes
              - Store project path in filter state
              - Generate hash-based storage key per project
            user_stories: [US5]
            depends_on: [T009]
        gate:
          name: "Persistence Validation"
          command: "npx tsc --noEmit src/renderer/stores/file-explorer-store.ts"
          on_fail: "Check localStorage available; verify project path passed correctly"

      - id: batch-6.2
        name: "App Lifecycle Integration"
        parallel: false
        context:
          - existing app initialization
          - project open hooks
        tasks:
          - id: T017
            title: "Hook persistence into app lifecycle"
            description: |
              - Load persisted filter on project open
              - Persist on filter change (already in applyFilterResults)
              - Clear on project close (optional)
            user_stories: [US5]
            depends_on: [T015, T016]
        gate:
          name: "Lifecycle Validation"
          command: "npx tsc --noEmit"
          on_fail: "Verify project open/close hooks exist; check timing of persistence calls"
    checkpoint: "User Story 5 complete — filter persists across sessions"
    independent_test: "Enter filter → close app → reopen → filter restored"

  - id: phase-7
    name: "Polish & Cross-Cutting"
    purpose: "Tests, edge cases, and final validation"
    blocking: true
    max_parallelism: 3
    batches:
      - id: batch-7.1
        name: "Unit Tests"
        parallel: true
        tasks:
          - id: T018
            title: "Create matcher unit tests"
            file: "src/renderer/lib/fuzzy-match/matcher.test.ts"
            description: |
              - Test sequential matching ("mcp" → "MyComponent")
              - Test case insensitivity
              - Test no match returns empty
              - Test positions are correct
            user_stories: []
            depends_on: [T009]
          - id: T019
            title: "Create FileTreeFilter unit tests"
            file: "src/renderer/components/file-explorer/FileTreeFilter.test.ts"
            description: |
              - Test input change triggers store action
              - Test clear button appears when query non-empty
              - Test Escape behavior
              - Test debounce timing
            user_stories: []
            depends_on: [T009]
        gate:
          name: "Test Validation"
          command: "npm test -- src/renderer/lib/fuzzy-match/matcher.test.ts src/renderer/components/file-explorer/FileTreeFilter.test.ts --passWithNoTests"
          on_fail: "Check Vitest config; verify test file locations"

      - id: batch-7.2
        name: "Edge Cases"
        parallel: false
        context:
          - spec.md#edge-cases
        tasks:
          - id: T020
            title: "Handle filter edge cases"
            description: |
              - Empty state message when no matches (FR-011)
              - Deep nested folders remain visible as ancestors (FR-004)
              - Special characters in query treated as literal
              - Long query truncation (MAX_FILTER_QUERY_LENGTH = 100)
            user_stories: []
            depends_on: [T011]
          - id: T021
            title: "Handle file system changes"
            description: |
              - Update filter results when files added/removed/renamed (FR-009)
              - Subscribe to file tree changes in store
            user_stories: []
            depends_on: [T017]
        gate:
          name: "Edge Case Validation"
          command: "npx tsc --noEmit"
          on_fail: "Review edge case implementations; check event subscriptions"

      - id: batch-7.3
        name: "E2E Test"
        parallel: false
        tasks:
          - id: T022
            title: "Create E2E tests"
            file: "tests/e2e/file-tree-filter.spec.ts"
            description: |
              - Test Mod+P focuses filter
              - Test typing filters file tree
              - Test matched characters highlighted
              - Test Escape clears filter
              - Test filter persists after app restart
            user_stories: []
            depends_on: [T021]
        gate:
          name: "E2E Validation"
          command: 'npx playwright test tests/e2e/file-tree-filter.spec.ts --reporter=list || echo "E2E tests require app running"'
          on_fail: "Verify Playwright setup; check app launch in test"

      - id: batch-7.4
        name: "Final Validation"
        parallel: false
        tasks:
          - id: T023
            title: "Run quickstart.md validation scenarios"
            description: "Manual validation of all quickstart scenarios"
            user_stories: []
            depends_on: [T022]
          - id: T024
            title: "Verify Constitution compliance"
            description: "Check keystroke latency < 16ms, accessibility requirements"
            user_stories: []
            depends_on: [T023]
        gate:
          name: "Final Gate"
          command: "npx tsc --noEmit && npm test -- --passWithNoTests"
          on_fail: "Review all type errors; fix failing tests"

# =============================================================================
# DEPENDENCY GRAPH
# =============================================================================

dependencies:
  # Phase 1 → Phase 2
  T002: [T001]
  T003: [T001]
  T004: [T001]
  T005: [T001]

  # Phase 2 internal
  T006: [T002, T003, T004, T005]

  # Phase 2 → Phase 3
  T007: [T006]
  T008: [T006]

  # Phase 3 internal
  T009: [T007, T008]

  # Phase 3 → Phase 4
  T010: [T009]
  T011: [T010]

  # Phase 3 → Phase 5
  T012: [T009]
  T013: [T009]
  T014: [T012, T013]

  # Phase 3 → Phase 6
  T015: [T009, T005]
  T016: [T009]
  T017: [T015, T016]

  # Phases 4,5,6 → Phase 7
  T018: [T009]
  T019: [T009]
  T020: [T011]
  T021: [T017]
  T022: [T021]
  T023: [T022]
  T024: [T023]

# =============================================================================
# CRITICAL PATH
# =============================================================================

critical_path:
  tasks: [T001, T002, T006, T007, T009, T010, T011, T020]
  length: 8
  description: "Setup → Types → Store → Filter → Tree → Highlight → Apply → Edge Cases"

# =============================================================================
# CROSS-PHASE PARALLELISM
# =============================================================================

parallel_execution:
  after_phase_3:
    phases: [phase-4, phase-5, phase-6]
    description: "Phases 4, 5, and 6 can run in parallel after Phase 3 completes"
    merge_point: phase-7

# =============================================================================
# USER STORY MAPPING
# =============================================================================

user_stories:
  US1:
    name: "Quick File Filtering"
    priority: P1
    tasks: [T007, T008, T009]
    phase: phase-3
    merged_with: US2
  US2:
    name: "Fuzzy Matching"
    priority: P1
    tasks: [T007, T008, T009]
    phase: phase-3
    merged_with: US1
  US3:
    name: "Visual Match Highlighting"
    priority: P2
    tasks: [T010, T011]
    phase: phase-4
  US4:
    name: "Keyboard Shortcut Access"
    priority: P2
    tasks: [T012, T013, T014]
    phase: phase-5
  US5:
    name: "Filter Persistence"
    priority: P3
    tasks: [T015, T016, T017]
    phase: phase-6

# =============================================================================
# NOTES
# =============================================================================

notes:
  - "Mod+P used instead of Mod+Shift+F due to conflict with Find/Replace"
  - "US1 and US2 merged as fuzzy matching is integral to filtering"
  - "Commit after each gate passes"
  - "Phases 4, 5, 6 are independent and can run in parallel"
